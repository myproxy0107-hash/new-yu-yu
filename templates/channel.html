<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="robots" content="noindex,nofollow">
        

        <title>{{ channel_name }}</title>
        <link rel="icon" href="/img/logo/favicon.ico">
        <link rel="stylesheet" href="/css/pure-min.css">
        <link rel="stylesheet" href="/css/grids-responsive-min.css">
        <link rel="stylesheet" href="/css/ionicons.min.css">
        <link rel="stylesheet" href="/css/default.css">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>

        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<style>	    /* 歯車（左下に固定） */
      .settings-toggle {
        position: fixed;
        left: 18px;
        bottom: 18px;
        z-index: 140;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
      }
      .settings-toggle .gear {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: rgba(0,0,0,0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 20px rgba(0,0,0,0.18);
        color: #fff;
        font-size: 20px;
      }
      /* 設定パネル（歯車の上に表示） */
      .settings-panel {
        position: fixed;
        bottom: 78px;
        left: 18px;
        width: 320px;
        max-width: calc(100% - 36px);
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 14px 40px rgba(0,0,0,0.18);
        padding: 16px;
        z-index: 139;
        transform-origin: bottom left;
        transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 180ms ease;
        opacity: 0;
        transform: translateY(10px) scale(.98);
        pointer-events: none;
      }
      .settings-panel.open {
        transform: translateY(0) scale(1);
        opacity: 1;
        pointer-events: auto;
      }
      .settings-panel h4 { margin: 0 0 10px; font-size: 1rem; color: #222; }
      .settings-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.04); }
      .settings-row:last-child { border-bottom: none; }
      .settings-row label { font-size: 0.92rem; color: #333; }
      .settings-row .desc { font-size: 0.8rem; color: #666; display:block; margin-top:6px; }

      /* トースト（右上） */
      .toast-wrap {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 150;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      .toast {
        min-width: 220px;
        max-width: 360px;
        background: linear-gradient(180deg,#fff,#f6f9ff);
        border-radius: 10px;
        padding: 12px 14px;
        box-shadow: 0 10px 30px rgba(14,30,37,0.12);
        color: #042a4a;
        font-size: 0.95rem;
        border-left: 4px solid #007BFF;
        transform: translateX(12px) translateY(-8px) scale(.98);
        opacity: 0;
        transition: transform 300ms cubic-bezier(.2,.9,.2,1), opacity 240ms ease;
        pointer-events: auto;
        touch-action: pan-y;
        user-select: none;
        position: relative;
      }
      .toast.show { transform: translateX(0) translateY(0) scale(1); opacity: 1; }
      .toast .title { font-weight: 700; margin-bottom: 6px; }
      .toast .body { font-weight: 500; color: #234; }
      .toast.dragging { transition: none; opacity: 0.95; }
      .toast .close-x { position: absolute; top: 6px; right: 8px; font-weight: 700; color: rgba(0,0,0,0.45); cursor: pointer; }
      .toast .hint { margin-top: 8px; font-size: 0.78rem; color: #556; display:block; }

      /* ---------- 追加終わり ---------- */
	</style>
    </head>
    <body>
     <header id="top-bar">
    <div class="navbar-logo">
      <a href="/"><img src="/img/logo/th.png" alt="Logo"></a>
    </div>
		 <div class="search-container">
      <form class="pure-form" action="/search" method="get">
        <fieldset>
          <input id="searchbox" name="q" type="search" placeholder="検索" title="検索" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false">
        </fieldset>
      </form>
    </div>
    <!-- モバイル用ハンバーガーアイコン -->
    <div id="hamburger">&#9776;</div>
    <!-- ナビゲーション -->
    <nav id="top-nav">
      <a href="/bbs">掲示板</a>
      <a href="/proxypage">Proxy</a>
      <a href="/others">その他</a>
      <a href="/sitsumon">回答よろ</a>
	&emsp;
    </nav>
  </header>
	    <br>
		 <button class="settings-toggle" id="settingsToggle" aria-label="設定を開く">
      <span class="gear">設定⚙️</span>
    </button>

    <!-- 設定パネル（歯車の上に立ち上がる） -->
    <div class="settings-panel" id="settingsPanel" role="dialog" aria-hidden="true" aria-labelledby="settingsTitle">
      <h4 id="settingsTitle">表示と再生の設定</h4>

      <div class="settings-row">
        <div>
          <label for="vcSelectPanel">再生モード</label>
          <div class="desc">リンク先を選択できます。設定はクッキーで保存されます。</div>
        </div>
        <div>
          <select id="vcSelectPanel" style="min-width:120px;">
         <option value="1">stream再生</option>
        <option value="2">高画質再生</option>
        <option value="3">nocookie</option>
        <option value="0">education</option>
          </select>
        </div>
      </div>

      <div class="settings-row">
        <div>
          <label for="proxyToggle">サムネイルプロキシ</label>
          <div class="desc">プロキシによるサムネイル取得をオンにします（クッキーで保存）</div>
        </div>
        <div>
          <input id="proxyToggle" type="checkbox" />
        </div>
      </div>

      <div style="padding-top:10px; text-align:right;">
        <button id="settingsSaveBtn" style="padding:8px 12px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); background:#007BFF; color:#fff; cursor:pointer;">保存</button>
      </div>
    </div>
        <div  class="no-theme">
        <span id="dark_mode_pref" style="display:none"></span>
        <div class="pure-g">
            <div class="pure-u-1 pure-u-md-2-24"></div>
            <div id="contents" class="pure-u-1 pure-u-md-20-24">
                
                <img id="cover_img" src="{{ cover_img_url }}" alt="カバー画像" style="margin: 1%">
                <div class="pure-g h-box">
                    <div class="pure-u-2-3">
                        <div class="channel-profile">
                            <img src="{{ channel_icon }}">
                            <span>{{ channel_name }}</span>
                        </div>
                        <p id="subscribers_count">チャンネル登録者数: {{ subscribers_count }}人</p>
                    </div>
                </div>
                
                <div class="h-box">
                    <div id="descriptionWrapper">
                        <p><span style="white-space:pre-wrap">{{ channel_profile | safe }}</span></p>
                    </div>
                </div>
                
                <div class="pure-g">
                    
                    {% for result in results %}
                    <div class="pure-u-1 pure-u-md-1-4">
                        <div class="h-box">
                            
                            {% if result["type"] == "video" %}
                            <a class="dynamic-link" href="{{ '/watch' if vc == '1' else ('/w' if vc == '2' else ('/ume' if vc == '3' else '/edu')) }}?v={{ result['id'] }}" style="width:100%">
                                <div class="thumbnail">
                                    <img class="thumbnail" loading="lazy" src="{% if proxy == "True" %}/thumbnail?v={{ result['id'] }}{% else %}https://img.youtube.com/vi/{{ result['id'] }}/0.jpg{% endif %}" onerror="document.cookie = 'proxy=True;max-age=2592000;';">
                                    <p class="length">{{ result["length_str"] }}</p>
                                </div>
                                <p dir="auto">{{ result['title'] }}</p>
                            </a>
                            <div class="video-card-row flexible">
                                <a href="/channel/{{ result['authorId'] }}">{{ result["author"] }}</a>
                            </div>
                            <div class="video-card-row flexible">
                                <div class="flex-left">
                                    <p class="video-data" dir="auto">{{ result['view_count_text'] }}</p>
                                    <p class="video-data" dir="auto">{{ result["published"] }}</p>
                                </div>
                            </div>
                            
                            {% elif result["type"] == "channel" %}
                            <a href="/channel/{{ result["id"] }}">
                                <center>
                                    <img loading="lazy" tabindex="-1" style="width:56.25%" src="{{ result["thumbnail"] }}">
                                </center>
                                <p dir="auto">{{ result["author"] }}</p>
                            </a>
                            
                            {% elif result["type"] == "playlist" %}
                            <a href="/playlist?list={{ result["id"] }}" style="width:100%;">
                            
                                <div class="thumbnail">
                                    <img loading="lazy" tabindex="-1" class="thumbnail" src="{% if proxy == "True" %}/thumbnail?v={{ result['thumbnail'] }}{% else %}https://img.youtube.com/vi/{{ result['thumbnail'] }}/0.jpg{% endif %}">
                                    <p class="length">{{ result["count"] }}個の動画</p>
                                </div>
                                <p dir="auto">{{ result["title"] }}</p>
                            </a>
                            
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
		</div>
			<!-- Toast container -->
    <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

 <script>
            $('#searchbox').autocomplete({
                source: function (request, response) {
                    {
                        var url = "/suggest?keyword=" + request.term;
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", url);
                        xhr.onload = function() {
                            response(JSON.parse(xhr.responseText));
                        }
                        xhr.send();
                    }
                },delay:300
        });
        </script>
			<!-- 設定パネル / トースト の動作スクリプト（重複抑制付き） -->
    <script>
      /* cookie helpers */
      function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? decodeURIComponent(v.pop()) : null;
      }
      function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days||30) * 24 * 60 * 60 * 1000);
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
      }

      document.addEventListener('DOMContentLoaded', function() {
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsSaveBtn = document.getElementById('settingsSaveBtn');
        const proxyToggle = document.getElementById('proxyToggle');
        const vcSelectPanel = document.getElementById('vcSelectPanel');

        // 初期値をクッキーから読み出し（なければ既定値）
        const vcCookie = getCookie('vc') || '0';
        if (vcSelectPanel) vcSelectPanel.value = vcCookie;
        const proxyCookie = getCookie('proxy') || ('{{ proxy }}' === 'True' ? 'True' : 'False');
        proxyToggle.checked = proxyCookie === 'True';

        function openSettings() {
          settingsPanel.classList.add('open');
          settingsPanel.setAttribute('aria-hidden', 'false');
        }
        function closeSettings() {
          settingsPanel.classList.remove('open');
          settingsPanel.setAttribute('aria-hidden', 'true');
        }

        settingsToggle.addEventListener('click', function(e){
          e.stopPropagation();
          if (settingsPanel.classList.contains('open')) closeSettings();
          else openSettings();
        });

        // クリックでパネル外を押したら閉じる
        document.addEventListener('click', function(e){
          if (!settingsPanel.contains(e.target) && !settingsToggle.contains(e.target)) closeSettings();
        });

        // 保存ボタン
        settingsSaveBtn.addEventListener('click', function(){
          const newVc = vcSelectPanel.value;
          setCookie('vc', newVc, 30);
          if (proxyToggle.checked) setCookie('proxy', 'True', 30);
          else setCookie('proxy', 'False', 30);

          // トースト表示（重複抑制付き）
          showToast('設定を保存しました!!', '保存完了');

          closeSettings();
        });
      });

      /* トースト（重複抑制 / 最大同時表示数）実装 */
      (function(){
        const wrap = document.getElementById('toastWrap');
        if (!wrap) return;

        const maxToasts = 3; // 同時表示数
        const dedupeMap = new Map(); // key -> {el, timeoutId, expiresAt}

        function makeKey(title, body) {
          return (title || '') + '||' + (body || '');
        }

        function ensureSpace() {
          const toasts = wrap.querySelectorAll('.toast');
          if (toasts.length < maxToasts) return;
          let oldest = null;
          toasts.forEach(t => {
            const created = parseInt(t.getAttribute('data-created') || '0', 10);
            if (!oldest || created < parseInt(oldest.getAttribute('data-created') || '0', 10)) oldest = t;
          });
          if (oldest) dismiss(oldest);
        }

        function createToastElement(title, body) {
          const el = document.createElement('div');
          el.className = 'toast';
          el.setAttribute('data-created', String(Date.now()));
          el.innerHTML = '<div class="close-x" aria-hidden="true">✕</div>' +
                         '<div class="title">' + (title || '') + '</div>' +
                         '<div class="body">' + (body || '') + '</div>' +
                         '<span class="hint">左から右へスライドで閉じる</span>';
          return el;
        }

        function dismiss(el) {
          if (!el || !el.parentNode) return;
          const key = el._toastKey;
          el.classList.remove('show');
          el.style.transform = 'translateX(14px) translateY(-8px) scale(.98)';
          el.style.opacity = '0';
          if (el._toastTimeoutId) clearTimeout(el._toastTimeoutId);
          if (key && dedupeMap.has(key)) dedupeMap.delete(key);
          setTimeout(()=> { try { el.remove(); } catch(e) {} }, 260);
        }

        function focusToast(el) {
          el.style.transition = 'none';
          el.style.transform = 'translateY(-6px)';
          setTimeout(()=> {
            el.style.transition = '';
            el.style.transform = '';
          }, 260);
        }

        function createOrRefreshToast(title, body, ttl = 4200) {
          const key = makeKey(title, body);

          if (dedupeMap.has(key)) {
            const info = dedupeMap.get(key);
            clearTimeout(info.timeoutId);
            info.timeoutId = setTimeout(()=> dismiss(info.el), ttl);
            info.expiresAt = Date.now() + ttl;
            focusToast(info.el);
            return info.el;
          }

          ensureSpace();

          const el = createToastElement(title, body);
          el._toastKey = key;
          wrap.appendChild(el);
          requestAnimationFrame(()=> el.classList.add('show') );

          const timeoutId = setTimeout(()=> dismiss(el), ttl);
          el._toastTimeoutId = timeoutId;

          dedupeMap.set(key, { el, timeoutId, expiresAt: Date.now() + ttl });

          const closeX = el.querySelector('.close-x');
          if (closeX) {
            closeX.addEventListener('click', function(e){
              e.stopPropagation();
              clearTimeout(el._toastTimeoutId);
              dismiss(el);
            });
          }

          let startX = 0;
          let currentX = 0;
          let dragging = false;

          function onPointerDown(ev) {
            dragging = true;
            el.classList.add('dragging');
            startX = ev.type && ev.type.startsWith && ev.type.startsWith('touch') ? ev.touches[0].clientX : ev.clientX;
            currentX = startX;
            el.style.transition = 'none';
          }
          function onPointerMove(ev) {
            if (!dragging) return;
            const clientX = ev.type && ev.type.startsWith && ev.type.startsWith('touch') ? ev.touches[0].clientX : ev.clientX;
            currentX = clientX;
            const dx = currentX - startX;
            el.style.transform = `translateX(${Math.max(0, dx)}px)`;
            el.style.opacity = String(Math.max(0, 1 - Math.abs(dx) / 300));
          }
          function onPointerUp(ev) {
            if (!dragging) return;
            dragging = false;
            el.classList.remove('dragging');
            el.style.transition = '';
            const dx = currentX - startX;
            if (dx > 120) {
              dismiss(el);
            } else {
              el.style.transform = '';
              el.style.opacity = '';
            }
          }

          el.addEventListener('mousedown', onPointerDown);
          window.addEventListener('mousemove', onPointerMove);
          window.addEventListener('mouseup', onPointerUp);
          el.addEventListener('touchstart', onPointerDown, {passive:true});
          window.addEventListener('touchmove', onPointerMove, {passive:true});
          window.addEventListener('touchend', onPointerUp);

          return el;
        }

        window.showToast = function(message, title, ttl) {
          const body = message || '';
          const head = title || '通知';
          const time = typeof ttl === 'number' ? ttl : 4200;
          createOrRefreshToast(head, body, time);
        };
      })();
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
  const vcSelect = document.getElementById('vcSelectPanel');
  const saveBtn = document.getElementById('settingsSaveBtn');

  function vcToPath(vc) {
    switch(String(vc)) {
      case '1': return '/watch';
      case '2': return '/w';
      case '3': return '/ume';
      default:  return '/edu';
    }
  }

  function setVcCookie(val) {
    const d = new Date();
    d.setTime(d.getTime() + 30*24*60*60*1000);
    document.cookie = 'vc=' + encodeURIComponent(String(val)) + ';expires=' + d.toUTCString() + ';path=/';
  }

  function replaceToVcPath(vcValue) {
    try {
      const targetPath = vcToPath(vcValue);
      const query = window.location.search || '';
      // 既に同じパスなら何もしない
      if (window.location.pathname === targetPath) return;
      // 履歴を残さず置き換えて遷移
      location.replace(targetPath + query);
    } catch (e) {
      console.warn('vc replace failed', e);
    }
  }

  // select の変更で即時反映（cookie 記録と遷移）
  if (vcSelect) {
    vcSelect.addEventListener('change', function () {
      const val = vcSelect.value;
      setVcCookie(val);
      replaceToVcPath(val);
    });
  }

  // 保存ボタンでも反映（既存の保存処理を優先するため短い遅延で実行）
  if (saveBtn) {
    saveBtn.addEventListener('click', function () {
      const val = vcSelect ? vcSelect.value : '0';
      setVcCookie(val);
      setTimeout(function () { replaceToVcPath(val); }, 40);
    });
  }


</script>
    <script>
document.addEventListener('DOMContentLoaded', function(){
  const saveBtn = document.getElementById('settingsSaveBtn');
  const vcSelect = document.getElementById('vcSelectPanel');
  if (!saveBtn || !vcSelect) return;

  // vc -> path
  function vcToPath(vc) {
    switch(String(vc)) {
      case '1': return '/watch';
      case '2': return '/w';
      case '3': return '/ume';
      default:  return '/edu';
    }
  }

  // cookie 書き込み
  function setVcCookie(val) {
    const d = new Date();
    d.setTime(d.getTime() + 30*24*60*60*1000);
    document.cookie = 'vc=' + encodeURIComponent(String(val)) + ';expires=' + d.toUTCString() + ';path=/';
  }

  // showToast が存在しない場合に備えた最小実装
  function ensureShowToastExists() {
    if (typeof window.showToast === 'function') return;
    window.showToast = function(message, title, ttl) {
      const wrapId = 'toastWrap';
      let wrap = document.getElementById(wrapId);
      if (!wrap) {
        wrap = document.createElement('div');
        wrap.id = wrapId;
        wrap.className = 'toast-wrap';
        wrap.style.position = 'fixed';
        wrap.style.top = '20px';
        wrap.style.right = '20px';
        wrap.style.zIndex = '150';
        document.body.appendChild(wrap);
      }
      const el = document.createElement('div');
      el.className = 'toast';
      el.setAttribute('data-created', String(Date.now()));
      el.innerHTML = '<div class="title">' + (title || '通知') + '</div><div class="body">' + (message || '') + '</div><div class="close-x" aria-hidden="true" style="position:absolute;right:8px;top:6px;cursor:pointer;">✕</div>';
      wrap.appendChild(el);
      requestAnimationFrame(()=> el.classList.add('show'));
      const time = typeof ttl === 'number' ? ttl : 4200;
      const tid = setTimeout(()=> {
        try { el.remove(); } catch(e){}
      }, time);
      const cx = el.querySelector('.close-x');
      if (cx) cx.addEventListener('click', function(e){ e.stopPropagation(); clearTimeout(tid); try{ el.remove(); }catch(_){} });
    };
  }

  // showToast を呼び、実際に DOM に追加されたトースト要素を監視して Promise を返す
  function showToastAsync(message, title, ttl) {
    ensureShowToastExists();
    return new Promise((resolve) => {
      const wrap = document.getElementById('toastWrap') || (function(){ const w = document.createElement('div'); w.id='toastWrap'; w.className='toast-wrap'; document.body.appendChild(w); return w; })();
      const before = Array.from(wrap.children);
      // call existing toast
      try { window.showToast(message, title, ttl); } catch(e){ console.warn('showToast failed', e); resolve(); return; }

      // find newly added toast (wait up to 200ms if not immediate)
      let newToast = null;
      const findNew = () => {
        const after = Array.from(wrap.children);
        for (let el of after) if (!before.includes(el)) return el;
        return null;
      };
      newToast = findNew();
      const maxWaitForInsert = 300;
      let waited = 0;
      const pollInterval = 50;
      const pollTimer = setInterval(() => {
        newToast = findNew();
        waited += pollInterval;
        if (newToast || waited >= maxWaitForInsert) {
          clearInterval(pollTimer);
          if (!newToast) {
            // If not found, fallback to waiting the ttl then resolve
            setTimeout(resolve, typeof ttl === 'number' ? ttl : 4200);
            return;
          }
          // Observe removal OR wait ttl
          const ttlMs = typeof ttl === 'number' ? ttl : 4200;
          let resolved = false;
          // If the toast element is removed, resolve early
          const mo = new MutationObserver(() => {
            if (!document.body.contains(newToast)) {
              if (!resolved) { resolved = true; mo.disconnect(); resolve(); }
            }
          });
          mo.observe(document.body, { childList: true, subtree: true });
          // Also watch for its removal from parent via periodic check (safety)
          const checkTimer = setInterval(() => {
            if (!document.body.contains(newToast)) {
              if (!resolved) { resolved = true; clearInterval(checkTimer); mo.disconnect(); resolve(); }
            }
          }, 150);
          // Fallback: resolve after ttl
          setTimeout(() => {
            if (!resolved) { resolved = true; clearInterval(checkTimer); mo.disconnect(); resolve(); }
          }, ttlMs + 100); // small buffer
        }
      }, pollInterval);
    });
  }

  // replace 実行
  function doReplaceForVc(val) {
    try {
      const target = vcToPath(val);
      const query = window.location.search || '';
      if (window.location.pathname === target) return;
      location.replace(target + query);
    } catch(e){ console.warn('replace error', e); }
  }

  // attach unified save handler (avoid duplicates)
  if (!saveBtn.__vc_postsave_attached__) {
    saveBtn.addEventListener('click', function(){
      // delay slightly so existing save logic runs first
      setTimeout(async function(){
        try {
          const val = vcSelect.value || '0';
          setVcCookie(val);

          // show toast and wait until it disappears or TTL
          // TTL: match your site's toast default if known; use 2000-4200ms typical.
          const ttl = 2000;
          await showToastAsync('設定を保存しました!!', '保存完了', ttl);

          // after toast lifecycle completes, perform replace
          doReplaceForVc(val);
        } catch(e){
          console.warn('post-save flow failed', e);
        }
      }, 40);
    }, false);
    saveBtn.__vc_postsave_attached__ = true;
  }

  // helper cookie writer used above
  function setVcCookie(val) {
    const d = new Date();
    d.setTime(d.getTime() + 30*24*60*60*1000);
    document.cookie = 'vc=' + encodeURIComponent(String(val)) + ';expires=' + d.toUTCString() + ';path=/';
  }

});
</script>


    </body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex,nofollow">
    <title>検索</title>
    <link rel="icon" href="/img/logo/favicon.ico">
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/ionicons.min.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <style>
        .contents #searchbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            text-align: right;
            z-index: 20;
            color: #ffffff;
        }
        #topButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007BFF;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #topButton:hover {
            background-color: #0056b3;
        }
        #topButton:active {
            transform: scale(0.95);
            background-color: #ff6347;
        }

        /* vc selector style */
        #vcSelect {
            margin-left: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }
        #vcStatus { font-size: 0.9em; margin-left: 8px; vertical-align: middle; }
    </style>
</head>
<body>
<header id="top-bar">
    <div class="navbar-logo">
      <a href="/"><img src="/img/logo/th.png" alt="Logo"></a>
    </div>
    <div id="hamburger">&#9776;</div>
    <nav id="top-nav">
      <a href="/bbs">掲示板</a>
      <a href="/proxypage">Proxy</a>
      <a href="/others">その他</a>
      <a href="/sitsumon">回答よろ</a>
    </nav>
</header>

<br>

<div class="no-theme">
    <span id="dark_mode_pref" style="display: none;"></span>
    <div class="pure-g">
        <div class="pure-u-1 pure-u-md-2-24"></div>

        <div id="contents" class="pure-u-1 pure-u-md-20-24">
            <div class="pure-g navbar h-box">
                <div class="pure-u-1 pure-u-md-12-24 searchbar">
                    <form class="pure-form" action="/search" method="get">
                        <fieldset>
                            <input id="searchbox" name="q" type="search" placeholder="検索" value="{{ word }}" title="検索" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false">
                        </fieldset>
                    </form>
                </div>

                <!-- 再生モード選択ドロップダウン -->
                <div class="pure-u-1 pure-u-md-12-24" style="text-align:right; padding-top:10px;">
                    <label for="vcSelect" style="font-size:0.9em; margin-right:6px;">再生モード</label>
                    <select id="vcSelect" name="vcSelect" aria-label="再生モード選択">
                        <option value="0">/watch (フルパス)</option>
                        <option value="1">/w (短縮)</option>
                        <option value="2">/ume (埋め込み)</option>
                        <option value="3">/edu (別モード)</option>
                    </select>
                    <span id="vcStatus"></span>
                </div>
            </div>

            <!-- 固定トップボタン（既存機能） -->
            <button id="topButton" onclick="toggleLink()">読み込み方を変更!</button>

            <script>
            let isWatch = true;
            function toggleLink() {
                // 既存別機能のプレースホルダ（具体的な制御は既存実装に依存）
                isWatch = !isWatch;
                alert(isWatch ? "埋め込みモードに変更されました！" : "デフォルトモードに変更されました！");
            }
            </script>

            <div class="pure-g">
                {% for result in results %}
                <div class="pure-u-1 pure-u-md-1-4">
                    <div class="h-box">
                        {% if result["type"] == "video" %}
                        <!-- class を dynamic-link に変更。初期パスはサーバー渡しの vc による -->
                        <a class="dynamic-link" href="{{ '/w' if vc == '1' else ('/ume' if vc == '2' else ('/edu' if vc == '3' else '/watch')) }}?v={{ result['id'] }}" style="width:100%">
                            <div class="thumbnail">
                                <img class="thumbnail" loading="lazy"
                                     src="{% if proxy == 'True' %}/thumbnail?v={{ result['id'] }}{% else %}https://img.youtube.com/vi/{{ result['id'] }}/0.jpg{% endif %}"
                                     onerror="document.cookie = 'proxy=True;max-age=2592000;';">
                                <p class="length">{{ result["length"] }}</p>
                            </div>
                            <p dir="auto">{{ result['title'] }}</p>
                        </a>

                        <div class="video-card-row flexible">
                            <a href="/channel/{{ result['authorId'] }}">{{ result["author"] }}</a>
                        </div>

                        <div class="video-card-row flexible">
                            <div class="flex-left">
                                <p class="video-data" dir="auto">{{ result["view_count_text"] }}</p>
                                <p class="video-data" dir="auto">{{ result["published"] }}</p>
                            </div>
                        </div>

                        {% elif result["type"] == "channel" %}
                        <a href="/channel/{{ result["id"] }}">
                            <center>
                                <img loading="lazy" tabindex="-1" style="width:56.25%" src="{{ result["thumbnail"] }}">
                            </center>
                            <p dir="auto">{{ result["author"] }}</p>
                        </a>

                        {% elif result["type"] == "playlist" %}
                        <a class="dynamic-link" style="width: 100%;" href="{{ '/w' if vc == '1' else ('/ume' if vc == '2' else ('/edu' if vc == '3' else '/watch')) }}?v={{ result['id'] }}">
                            <div class="thumbnail">
                                <img loading="lazy" tabindex="-1" class="thumbnail" src="{{ result['thumbnail'] }}">
                                <p class="length">{{ result["count"] }}個の動画</p>
                            </div>
                            <p dir="auto">{{ result["title"] }}</p>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="pure-g h-box">
        <div class="pure-u-1 pure-u-lg-1-5"></div>
    </div>

    <div class="pure-u-1 pure-u-lg-3-5"></div>
    <div class="pure-u-1 pure-u-lg-1-5" style="text-align:right">
        <a href="{{ next }}">次のページ</a>
    </div>
</div>

<script>
/* cookie ヘルパー */
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? decodeURIComponent(v.pop()) : null;
}
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days||30) * 24 * 60 * 60 * 1000);
  const expires = "expires=" + d.toUTCString();
  document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
}

/* vc 値からパスへ変換するヘルパー */
function vcToPath(vc) {
  switch(vc) {
    case '1': return '/w';
    case '2': return '/ume';
    case '3': return '/edu';
    default:  return '/watch';
  }
}

/* 全 dynamic-link の href を選択中のパスに切り替える */
function applyVcToLinks(vc) {
  const targetPath = vcToPath(vc);
  const links = document.querySelectorAll('a.dynamic-link');
  links.forEach(a => {
    try {
      const url = new URL(a.getAttribute('href'), window.location.origin);
      // pathname を常に targetPath に置換（既存クエリは維持）
      url.pathname = targetPath;
      a.setAttribute('href', url.pathname + url.search);
    } catch (e) {
      // 簡易的な置換（相対パスなど）
      let href = a.getAttribute('href') || '';
      // 最初に ? が現れる位置を確認して、パス部分のみ置換
      const idx = href.indexOf('?');
      const query = idx >= 0 ? href.slice(idx) : '';
      a.setAttribute('href', targetPath + query);
    }
  });
  const st = document.getElementById('vcStatus');
  if (st) {
    let label = '';
    switch(vc) {
      case '1': label = '現在: 短縮パス /w'; break;
      case '2': label = '現在: 埋め込み /ume'; break;
      case '3': label = '現在: 別モード /edu'; break;
      default:  label = '現在: フルパス /watch';
    }
    st.textContent = label;
  }
}

/* ドロップダウン選択が変わったときの処理 */
function onVcSelectChange(ev) {
  const val = ev.target.value;
  setCookie('vc', val, 30);
  applyVcToLinks(val);
}

/* 初期化 */
document.addEventListener('DOMContentLoaded', function() {
  // サーバーが渡した初期値（テンプレート埋め込み）
  const serverVc = '{{ vc }}';
  const cookieVc = getCookie('vc');
  const vc = cookieVc !== null ? cookieVc : serverVc || '0';
  if (cookieVc === null) setCookie('vc', vc, 30);

  // セレクト要素に反映
  const sel = document.getElementById('vcSelect');
  if (sel) {
    sel.value = vc;
    sel.addEventListener('change', onVcSelectChange);
  }

  applyVcToLinks(vc);

  // 検索補完（既存）
  $('#searchbox').autocomplete({
    source: function (request, response) {
      var url = "/suggest?keyword=" + request.term;
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.onload = function() {
        try { response(JSON.parse(xhr.responseText)); } catch(e) { response([]); }
      };
      xhr.send();
    }, delay: 300
  });

  // ハンバーガーとトップバーのスクロール縮小（既存）
  $("#hamburger").click(function() { $("#top-nav").toggleClass("show"); });
  $(window).on("scroll", function() {
    if($(window).scrollTop() > 50) { $("#top-bar").addClass("scrolled"); }
    else { $("#top-bar").removeClass("scrolled"); }
  });
});
</script>
</body>
</html>

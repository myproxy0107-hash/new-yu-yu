<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex,nofollow">
    <title>検索</title>
    <link rel="icon" href="/img/logo/favicon.ico">
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/ionicons.min.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <style>
        /* ---------- keep original searchbar layout ---------- */
        .contents #searchbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            text-align: right;
            z-index: 20;
            color: #ffffff;
        }
        #topButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007BFF;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #topButton:hover { background-color: #0056b3; }
        #topButton:active { transform: scale(0.95); background-color: #ff6347; }

        /* ---------- card / thumbnail visuals (non-invasive) ---------- */
        a.dynamic-link {
          display: block;
          color: inherit;
          text-decoration: none;
          background: #fff;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 2px 6px rgba(0,0,0,0.08);
          transition: transform 180ms ease, box-shadow 180ms ease;
          border: 1px solid rgba(0,0,0,0.05);
        }
        a.dynamic-link:hover, a.dynamic-link:focus {
          transform: translateY(-6px);
          box-shadow: 0 10px 30px rgba(0,0,0,0.12);
          outline: none;
        }
        a.dynamic-link .thumbnail {
          position: relative;
          background: #000;
          height: 0;
          padding-bottom: 56.25%;
          overflow: hidden;
        }
        a.dynamic-link .thumbnail img.thumbnail {
          position: absolute;
          inset: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
          transition: transform 240ms ease;
        }
        a.dynamic-link:hover .thumbnail img.thumbnail { transform: scale(1.03); }
        a.dynamic-link .length {
          position: absolute;
          right: 8px;
          bottom: 8px;
          background: rgba(0,0,0,0.75);
          color: #fff;
          padding: 4px 7px;
          border-radius: 6px;
          font-size: 0.8rem;
          z-index: 3;
          box-shadow: 0 1px 4px rgba(0,0,0,0.4);
        }
        a.dynamic-link > p[dir="auto"] {
          margin: 10px 12px 6px;
          font-weight: 600;
          color: #222;
          font-size: 0.95rem;
          line-height: 1.25;
          overflow: hidden;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
        }
        .video-card-row.flexible {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0 12px 10px;
          gap: 8px;
          color: #666;
          font-size: 0.85rem;
        }
        .video-card-row.flexible a { color: #007BFF; text-decoration: none; font-weight: 500; }
        .video-card-row.flexible a:hover { text-decoration: underline; }
        .video-data { margin: 0; display: inline-block; color: #666; font-size: 0.82rem; }

        /* vc selector / status (kept minimal) */
        #vcStatus { display: inline-block; color: #444; font-size: 0.88rem; margin-left: 10px; vertical-align: middle; }

        /* topBar behavior */
        #top-bar { transition: background 200ms ease, box-shadow 200ms ease; }
        #top-bar.scrolled { background: rgba(255,255,255,0.96); box-shadow: 0 3px 12px rgba(0,0,0,0.06); }

        @media (max-width: 640px) {
          a.dynamic-link { border-radius: 6px; }
          .pure-u-1.pure-u-md-1-4 { padding: 6px 8px; }
          .pure-u-1.pure-u-md-12-24.searchbar { padding-right: 0; }
        }

        /* ---------- settings panel (overlay) ---------- */
        /* gear moved to left-bottom */
        .settings-toggle {
          position: fixed;
          left: 18px;
          bottom: 18px;
          z-index: 140;
          background: transparent;
          border: none;
          cursor: pointer;
          font-size: 20px;
          color: #fff;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .settings-toggle .gear {
          width: 44px;
          height: 44px;
          border-radius: 10px;
          background: rgba(0,0,0,0.55);
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 20px rgba(0,0,0,0.18);
          color: #fff;
          font-size: 20px;
        }
        .settings-panel {
          position: fixed;
          bottom: 78px;
          left: 18px;
          width: 320px;
          max-width: calc(100% - 36px);
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 14px 40px rgba(0,0,0,0.18);
          padding: 16px;
          z-index: 139;
          transform-origin: bottom left;
          transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 180ms ease;
          opacity: 0;
          transform: translateY(10px) scale(.98);
          pointer-events: none;
        }
        .settings-panel.open {
          transform: translateY(0) scale(1);
          opacity: 1;
          pointer-events: auto;
        }
        .settings-panel h4 { margin: 0 0 10px; font-size: 1rem; color: #222; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .settings-row:last-child { border-bottom: none; }
        .settings-row label { font-size: 0.92rem; color: #333; }
        .settings-row .desc { font-size: 0.8rem; color: #666; display:block; margin-top:6px; }

        /* ---------- toast (notification) ---------- */
        .toast-wrap {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 150;
          display: flex;
          flex-direction: column;
          gap: 10px;
          pointer-events: none;
        }
        .toast {
          min-width: 220px;
          max-width: 360px;
          background: linear-gradient(180deg,#fff,#f6f9ff);
          border-radius: 10px;
          padding: 12px 14px;
          box-shadow: 0 10px 30px rgba(14,30,37,0.12);
          color: #042a4a;
          font-size: 0.95rem;
          border-left: 4px solid #007BFF;
          transform: translateX(12px) translateY(-8px) scale(.98);
          opacity: 0;
          transition: transform 300ms cubic-bezier(.2,.9,.2,1), opacity 240ms ease;
          pointer-events: auto;
          touch-action: pan-y;
          user-select: none;
        }
        .toast.show { transform: translateX(0) translateY(0) scale(1); opacity: 1; }
        .toast .title { font-weight: 700; margin-bottom: 6px; }
        .toast .body { font-weight: 500; color: #234; }
        .toast.dragging { transition: none; opacity: 0.95; }
        .toast .close-x { position: absolute; top: 6px; right: 8px; font-weight: 700; color: rgba(0,0,0,0.45); cursor: pointer; }
        .toast .hint { margin-top: 8px; font-size: 0.78rem; color: #556; display:block; }

    </style>
</head>
<body>
<header id="top-bar">
    <div class="navbar-logo">
      <a href="/"><img src="/img/logo/th.png" alt="Logo"></a>
    </div>
    <div id="hamburger">&#9776;</div>
    <nav id="top-nav">
      <a href="/bbs">掲示板</a>
      <a href="/proxypage">Proxy</a>
      <a href="/others">その他</a>
      <a href="/sitsumon">回答よろ</a>
    </nav>
</header>

<!-- Settings toggle (gear) moved to left-bottom -->
<button class="settings-toggle" id="settingsToggle" aria-label="設定を開く">
  <span class="gear">⚙️</span>
</button>

<!-- Settings panel (appears above gear) -->
<div class="settings-panel" id="settingsPanel" role="dialog" aria-hidden="true" aria-labelledby="settingsTitle">
  <h4 id="settingsTitle">表示と再生の設定</h4>

  <div class="settings-row">
    <div>
      <label for="vcSelectPanel">再生モード</label>
      <div class="desc">リンク先を選択できます。設定はクッキーで保存されます。</div>
    </div>
    <div>
      <select id="vcSelectPanel" style="min-width:120px;">
        <option value="0">/watch (フルパス)</option>
        <option value="1">/w (短縮)</option>
        <option value="2">/ume (埋め込み)</option>
        <option value="3">/edu (別モード)</option>
      </select>
    </div>
  </div>

  <div class="settings-row">
    <div>
      <label for="proxyToggle">サムネイルプロキシ</label>
      <div class="desc">プロキシによるサムネイル取得をオンにします（クッキーで保存）</div>
    </div>
    <div>
      <input id="proxyToggle" type="checkbox" />
    </div>
  </div>

  <div style="padding-top:10px; text-align:right;">
    <button id="settingsSaveBtn" style="padding:8px 12px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); background:#007BFF; color:#fff; cursor:pointer;">保存</button>
  </div>
</div>

<br>

<div class="no-theme">
    <span id="dark_mode_pref" style="display: none;"></span>
    <div class="pure-g">
        <div class="pure-u-1 pure-u-md-2-24"></div>

        <div id="contents" class="pure-u-1 pure-u-md-20-24">
            <div class="pure-g navbar h-box">
                <div class="pure-u-1 pure-u-md-12-24 searchbar">
                    <form class="pure-form" action="/search" method="get">
                        <fieldset>
                            <input id="searchbox" name="q" type="search" placeholder="検索" value="{{ word }}" title="検索" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false">
                        </fieldset>
                    </form>
                </div>
                <!-- searchbar restored to original; no selector next to it -->
            </div>

            <!-- 固定トップボタン（既存機能） -->
            <button id="topButton" onclick="toggleLink()">読み込み方を変更!</button>

            <script>
            let isWatch = true;
            function toggleLink() {
                isWatch = !isWatch;
                showToast(isWatch ? "埋め込みモードに変更されました！" : "デフォルトモードに変更されました！");
            }
            </script>

            <div class="pure-g">
                {% for result in results %}
                <div class="pure-u-1 pure-u-md-1-4" style="padding:10px;">
                    <div class="h-box">
                        {% if result["type"] == "video" %}
                        <a class="dynamic-link" href="{{ '/w' if vc == '1' else ('/ume' if vc == '2' else ('/edu' if vc == '3' else '/watch')) }}?v={{ result['id'] }}" style="width:100%">
                            <div class="thumbnail">
                                <img class="thumbnail" loading="lazy"
                                     src="{% if proxy == 'True' %}/thumbnail?v={{ result['id'] }}{% else %}https://img.youtube.com/vi/{{ result['id'] }}/0.jpg{% endif %}"
                                     onerror="document.cookie = 'proxy=True;max-age=2592000;';">
                                <p class="length">{{ result["length"] }}</p>
                            </div>
                            <p dir="auto">{{ result['title'] }}</p>
                        </a>

                        <div class="video-card-row flexible">
                            <a href="/channel/{{ result['authorId'] }}">{{ result["author"] }}</a>
                        </div>

                        <div class="video-card-row flexible">
                            <div class="flex-left">
                                <p class="video-data" dir="auto">{{ result["view_count_text"] }}</p>
                                <p class="video-data" dir="auto">{{ result["published"] }}</p>
                            </div>
                        </div>

                        {% elif result["type"] == "channel" %}
                        <a href="/channel/{{ result["id"] }}">
                            <center>
                                <img loading="lazy" tabindex="-1" style="width:56.25%" src="{{ result["thumbnail"] }}">
                            </center>
                            <p dir="auto">{{ result["author"] }}</p>
                        </a>

                        {% elif result["type"] == "playlist" %}
                        <a class="dynamic-link" style="width: 100%;" href="{{ '/w' if vc == '1' else ('/ume' if vc == '2' else ('/edu' if vc == '3' else '/watch')) }}?v={{ result['id'] }}">
                            <div class="thumbnail">
                                <img loading="lazy" tabindex="-1" class="thumbnail" src="{{ result['thumbnail'] }}">
                                <p class="length">{{ result["count"] }}個の動画</p>
                            </div>
                            <p dir="auto">{{ result["title"] }}</p>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="pure-g h-box">
        <div class="pure-u-1 pure-u-lg-1-5"></div>
    </div>

    <div class="pure-u-1 pure-u-lg-3-5"></div>
    <div class="pure-u-1 pure-u-lg-1-5" style="text-align:right">
        <a href="{{ next }}">次のページ</a>
    </div>
</div>

<!-- Toast container -->
<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ---------- ヘルパー（既存と重複しないようあれば統合してください） ---------- */
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? decodeURIComponent(v.pop()) : null;
}
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days||30) * 24 * 60 * 60 * 1000);
  const expires = "expires=" + d.toUTCString();
  document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
}

/* ---------- vc -> path helper ---------- */
function vcToPath(vc) {
  switch(String(vc)) {
    case '1': return '/w';
    case '2': return '/ume';
    case '3': return '/edu';
    default:  return '/watch';
  }
}

/* ---------- applyVcToLinks（リンクの href のみを書き換える。表示は変更しない） ---------- */
function applyVcToLinks(vc) {
  const resolvedVc = String(vc !== undefined && vc !== null ? vc : (getCookie('vc') || '0'));
  const targetPath = vcToPath(resolvedVc);

  // 対象セレクタ（必要なら追加）。この関数は href のみ変更し、DOM構造やクラス・スタイルは触りません。
  const selectors = [
    'a.dynamic-link',
    'a.recommendation-link',
    'a[href^="/watch"]',
    'a[href^="/w"]',
    'a[href^="/ume"]',
    'a[href^="/edu"]'
  ];

  const elements = new Set();
  selectors.forEach(sel => {
    try { document.querySelectorAll(sel).forEach(el => elements.add(el)); }
    catch(e) { /* invalid selector は無視 */ }
  });

  elements.forEach(a => {
    try {
      const originalHref = a.getAttribute('href') || '';
      try {
        const url = new URL(originalHref, window.location.origin);
        const search = url.search || '';
        url.pathname = targetPath;
        a.setAttribute('href', url.pathname + search);
      } catch (e) {
        // フォールバック：? 以降を保持して path を置換
        const idx = originalHref.indexOf('?');
        const query = idx >= 0 ? originalHref.slice(idx) : '';
        a.setAttribute('href', targetPath + query);
      }
    } catch (err) {
      console.warn('applyVcToLinks skipped element', a, err);
    }
  });

  // 表示用ステータスの更新（存在すれば）
  const st = document.getElementById('vcStatus');
  if (st) {
    let label = '';
    switch (targetPath) {
      case '/w':  label = '現在: 短縮パス /w'; break;
      case '/ume': label = '現在: 埋め込み /ume'; break;
      case '/edu': label = '現在: 別モード /edu'; break;
      default:    label = '現在: フルパス /watch';
    }
    st.textContent = label;
  }
}

/* ---------- video ページ時に現在の URL を即時更新する処理 ---------- */
function updateCurrentVideoUrlPath(vc) {
  // 対象ページかどうかを判定（/watch, /w, /ume, /edu のいずれかの場合）
  const currentPath = window.location.pathname || '';
  const isVideoPage = /^\/(watch|w|ume|edu)$/.test(currentPath);
  if (!isVideoPage) return; // video.html 以外では何もしない

  // クエリ（?v=... 等）は保持する
  const query = window.location.search || '';
  const newPath = vcToPath(vc) + query;

  // 履歴を残さずアドレスバーだけ書き換え
  try {
    history.replaceState(history.state, document.title, newPath);
  } catch (e) {
    // 古いブラウザではフォールバックして location.replace（ページリロード）を行わない方針なのでログのみ
    console.warn('history.replaceState failed', e);
  }
}

/* ---------- setVcAndApply: 設定保存時にクッキー保存・リンク更新・video URL 即時反映を行うユーティリティ ---------- */
function setVcAndApply(newVc) {
  newVc = String(newVc);
  setCookie('vc', newVc, 30);

  // 1) ページ内のリンクを書き換え（表示はそのまま）
  applyVcToLinks(newVc);

  // 2) video ページなら今見ている URL を即時書き換える（アドレスバーのみ）
  updateCurrentVideoUrlPath(newVc);

  // 3) 見た目の通知（既存の showToast があれば利用）
  if (typeof showToast === 'function') {
    const modeLabel = (newVc === '1' ? '/w' : (newVc === '2' ? '/ume' : (newVc === '3' ? '/edu' : '/watch')));
    showToast(modeLabel + ' に変更しました!!', '変更完了');
  } else {
    console.info('vc changed to', newVc);
  }
}

/* ---------- 使い方（既存の settings 保存ハンドラに組み込む例） ----------
settingsSaveBtn.addEventListener('click', function(){
  const newVc = vcSelectPanel.value;
  // proxy は既存の処理に任せる
  if (proxyToggle.checked) setCookie('proxy','True',30); else setCookie('proxy','False',30);

  // 即時反映
  setVcAndApply(newVc);

  // パネルを閉じる等の既存処理
  closeSettings();
});
------------------------------------------------------------------- */

  // autocomplete and header behaviour
  $('#searchbox').autocomplete({
    source: function (request, response) {
      var url = "/suggest?keyword=" + request.term;
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.onload = function() {
        try { response(JSON.parse(xhr.responseText)); } catch(e) { response([]); }
      };
      xhr.send();
    }, delay: 300
  });

  $("#hamburger").click(function() { $("#top-nav").toggleClass("show"); });
  $(window).on("scroll", function() {
    if($(window).scrollTop() > 50) { $("#top-bar").addClass("scrolled"); }
    else { $("#top-bar").removeClass("scrolled"); }
  });
});

/* ---------- Toast implementation (右上表示・左から右にスライドで閉じる) ---------- */
(function(){
  const wrap = document.getElementById('toastWrap');
  if (!wrap) return;

  function createToast(title, body, ttl = 4200) {
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = '<div class="close-x" aria-hidden="true">✕</div>' +
                   '<div class="title">' + (title || '') + '</div>' +
                   '<div class="body">' + (body || '') + '</div>' +
                   '<span class="hint">左から右へスライドで閉じる</span>';
    wrap.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show') );

    const timeoutId = setTimeout(()=> dismiss(el), ttl);

    el.querySelector('.close-x').addEventListener('click', function(e){
      e.stopPropagation();
      clearTimeout(timeoutId);
      dismiss(el);
    });

    let startX = 0;
    let currentX = 0;
    let dragging = false;

    function onPointerDown(ev) {
      dragging = true;
      el.classList.add('dragging');
      startX = ev.type.startsWith('touch') ? ev.touches[0].clientX : ev.clientX;
      currentX = startX;
      el.style.transition = 'none';
    }
    function onPointerMove(ev) {
      if (!dragging) return;
      const clientX = ev.type.startsWith('touch') ? ev.touches[0].clientX : ev.clientX;
      currentX = clientX;
      const dx = currentX - startX;
      // only allow left->right (positive) visual
      el.style.transform = `translateX(${Math.max(0, dx)}px)`;
      el.style.opacity = String(Math.max(0, 1 - Math.abs(dx) / 300));
    }
    function onPointerUp(ev) {
      if (!dragging) return;
      dragging = false;
      el.classList.remove('dragging');
      el.style.transition = '';
      const dx = currentX - startX;
      if (dx > 120) dismiss(el);
      else {
        el.style.transform = '';
        el.style.opacity = '';
      }
    }

    el.addEventListener('mousedown', onPointerDown);
    window.addEventListener('mousemove', onPointerMove);
    window.addEventListener('mouseup', onPointerUp);
    el.addEventListener('touchstart', onPointerDown, {passive:true});
    window.addEventListener('touchmove', onPointerMove, {passive:true});
    window.addEventListener('touchend', onPointerUp);

    return el;
  }

  function dismiss(el) {
    if (!el) return;
    el.classList.remove('show');
    el.style.transform = 'translateX(14px) translateY(-8px) scale(.98)';
    el.style.opacity = '0';
    setTimeout(()=> { try { el.remove(); } catch(e) {} }, 260);
  }

  window.showToast = function(message, title) {
    createToast(title || '通知', message || '', 4200);
  };
})();

/* helper exposed for compatibility */
function toggleVc() {
  const current = getCookie('vc') || '{{ vc }}';
  const next = current === '1' ? '0' : '1';
  setCookie('vc', next, 30);
  applyVcToLinks(next);
  showToast(next === '1' ? '/w に変更しました!!' : '/watch に変更しました!!');
}
function setVcMode(val) {
  setCookie('vc', val, 30);
  applyVcToLinks(val);
  showToast((val === '1' ? '/w' : (val === '2' ? '/ume' : (val === '3' ? '/edu' : '/watch'))) + ' に変更しました!!');
}
</script>
</body>
</html>

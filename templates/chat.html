<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <style>
    .message-container { border-bottom: 1px solid #eee; padding: 8px; }
    .message-header { font-weight: bold; margin-bottom: 4px; }
    .message-text .quote { color: #555; border-left: 3px solid #ddd; padding-left: 6px; margin: 2px 0; }
    .message-time { font-size: 0.8em; color: #666; margin-top: 4px; }
    .action-menu { position: absolute; background: #fff; border: 1px solid #ccc; box-shadow: 0 2px 6px rgba(0,0,0,0.15); display: none; }
    .action-menu div { padding: 6px 10px; cursor: pointer; }
    .action-menu div:hover { background: #f5f5f5; }
    .hamburger { margin-left: 8px; cursor: pointer; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; }
    #current-topic { margin-bottom: 8px; display:none; }
  </style>
</head>
<body>
  <div id="user-auth">
    <input id="signupName" placeholder="名前">
    <input id="signupPassword" type="password" placeholder="パスワード">
    <button id="signupButton">サインアップ</button>
    <br>
    <input id="loginName" placeholder="名前">
    <input id="loginPassword" type="password" placeholder="パスワード">
    <button id="loginButton">ログイン</button>
  </div>

  <div id="chat-section" style="display:none;">
    <div id="current-topic"></div>
    <div id="chat-box"></div>
    <input id="messageInput" placeholder="メッセージ">
    <button id="sendButton">送信</button>
    <button id="logoutButton">ログアウト</button>
    <!-- hiddenIntro は UI に表示しない（内部保持用） -->
    <div id="user-intro" style="display:none;"></div>
  </div>

<script type="module">
  // Firebaseモジュールのインポート
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    updateProfile,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    getDocs,
    updateDoc,
    onSnapshot,
    query,
    orderBy,
    getDoc,
    setDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  import {
    getDatabase,
    ref,
    onDisconnect,
    set,
    serverTimestamp,
    onValue
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

  // Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyBy2-A1aPIJ5sgdIkdtVP8M3ejYWh1SUU4",
    authDomain: "chat-chat-2518e.firebaseapp.com",
    projectId: "chat-chat-2518e",
    storageBucket: "chat-chat-2518e.firebasestorage.app",
    messagingSenderId: "465019906626",
    appId: "1:465019906626:web:1de95eec38a8bbf5c65bdb",
    measurementId: "G-HVV4XD4D6J"
  };

  // 初期化
  const appFB = initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getFirestore(appFB);
  const dbRT = getDatabase(appFB);

  const MAX_MESSAGES = 50;
  let pseudoAdmins = new Set();
  let mutedUsers = {};

  // currentTopic RTDB
  const currentTopicRef = ref(dbRT, "currentTopic");

  async function updateCurrentTopic(topicText) {
    try {
      await set(currentTopicRef, topicText);
      console.log("currentTopic を更新しました:", topicText);
    } catch (error) {
      console.error("currentTopic 更新エラー:", error);
    }
  }

  onValue(currentTopicRef, (snapshot) => {
    const topic = snapshot.val();
    const topicElem = document.getElementById("current-topic");
    if (topic) {
      topicElem.textContent = topic;
      topicElem.style.display = "block";
    } else {
      topicElem.style.display = "none";
    }
  });

  // YouTube ID 抽出
  function extractVideoId(url) {
    const regExp = /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[1].length === 11) ? match[1] : null;
  }

  // ユーティリティ
  function generateEmailFromName(name) {
    return name.trim().toLowerCase().replace(/\s+/g, "") + "@chatapp.local";
  }
  function generateForcedId() {
    return Math.floor(1000 + Math.random() * 9000).toString();
  }
  function getBaseName(displayName) {
    if (!displayName) return "";
    const idx = displayName.indexOf("#");
    return idx === -1 ? displayName : displayName.slice(0, idx);
  }

  const CLEAR_CHAT_PASSWORD = "RESET1234";

  // 要素参照
  const signupButton = document.getElementById("signupButton");
  const loginButton  = document.getElementById("loginButton");
  const logoutButton = document.getElementById("logoutButton");
  const sendButton   = document.getElementById("sendButton");
  const chatBox      = document.getElementById("chat-box");
  const messageInput = document.getElementById("messageInput");

  // モーダル（編集）
  function openEditModal(currentText, callback) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '2000';

    const modal = document.createElement('div');
    modal.style.backgroundColor = '#fff';
    modal.style.padding = '20px';
    modal.style.borderRadius = '5px';
    modal.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
    modal.style.maxWidth = '500px';
    modal.style.width = '90%';

    const title = document.createElement('h3');
    title.innerText = 'メッセージ編集';
    modal.appendChild(title);

    const textarea = document.createElement('textarea');
    textarea.style.width = '100%';
    textarea.style.height = '150px';
    textarea.value = currentText;
    modal.appendChild(textarea);

    const btnContainer = document.createElement('div');
    btnContainer.style.marginTop = '10px';
    btnContainer.style.textAlign = 'right';

    const saveBtn = document.createElement('button');
    saveBtn.innerText = '保存';
    saveBtn.style.marginRight = '10px';
    saveBtn.onclick = () => {
      callback(textarea.value);
      document.body.removeChild(overlay);
    };
    btnContainer.appendChild(saveBtn);

    const cancelBtn = document.createElement('button');
    cancelBtn.innerText = 'キャンセル';
    cancelBtn.onclick = () => {
      document.body.removeChild(overlay);
    };
    btnContainer.appendChild(cancelBtn);

    modal.appendChild(btnContainer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  // ミュート判定
  function isMuted(userBaseName) {
    if (mutedUsers[userBaseName]) {
      if (Date.now() < mutedUsers[userBaseName]) {
        return true;
      } else {
        delete mutedUsers[userBaseName];
      }
    }
    return false;
  }

  // おみくじ
  const fortuneOptions = [
    { name: "…あれ？……何故か表示されません…", weight: 1 },
    { name: "極大吉", weight: 2 },
    { name: "超大吉", weight: 2 },
    { name: "大吉", weight: 10 },
    { name: "吉", weight: 20 },
    { name: "中吉", weight: 20 },
    { name: "小吉", weight: 20 },
    { name: "末吉", weight: 10 },
    { name: "凶", weight: 10 },
    { name: "大凶", weight: 5 }
  ];
  function weightedRandom(options) {
    let totalWeight = options.reduce((sum, opt) => sum + opt.weight, 0);
    let rand = Math.random() * totalWeight;
    for (let opt of options) {
      if (rand < opt.weight) return opt.name;
      rand -= opt.weight;
    }
    return options[options.length - 1].name;
  }

  // Presence 設定
  function setupPresence(user) {
    const userStatusRef = ref(dbRT, "status/" + user.uid);
    const connectedRef = ref(dbRT, ".info/connected");
    onValue(connectedRef, (snapshot) => {
      if (snapshot.val() === true) {
        onDisconnect(userStatusRef)
          .set({
            displayName: user.displayName,
            status: "offline",
            last_changed: serverTimestamp()
          })
          .then(() => {
            set(userStatusRef, {
              displayName: user.displayName,
              status: "online",
              last_changed: serverTimestamp()
            });
          })
          .catch((error) => {
            console.error("onDisconnect 設定エラー:", error);
          });
      }
    });
  }

  // Firestore: ユーザードキュメント初期化（hiddenIntro）
  async function ensureUserDoc(user) {
    if (!user) return;
    const userDocRef = doc(db, "users", user.uid);
    const snap = await getDoc(userDocRef);
    if (!snap.exists()) {
      await setDoc(userDocRef, {
        displayName: user.displayName || "",
        hiddenIntro: "/nor/",
        createdAt: new Date()
      }, { merge: true });
    }
  }

  // hiddenIntro 更新
  async function setHiddenIntro(user, introText) {
    if (!user) return;
    await setDoc(doc(db, "users", user.uid), {
      hiddenIntro: introText
    }, { merge: true });
  }

  // hiddenIntro 取得
  async function getHiddenIntro(user) {
    if (!user) return "/nor/";
    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return "/nor/";
    const data = snap.data();
    return data.hiddenIntro || "/nor/";
  }

  // hiddenIntro リアルタイム監視（UI非表示、内部保持）
  function watchUserIntro(user) {
    if (!user) return;
    const userDocRef = doc(db, "users", user.uid);
    onSnapshot(userDocRef, (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        const intro = data.hiddenIntro || "/nor/";
        document.getElementById("user-intro").textContent = intro; // 非表示だが保持
        console.log("hiddenIntro 更新:", intro);
      }
    });
  }

  // 権限判定（hiddenIntro のあるなし：/nor/ 以外なら特権）
  async function isPrivileged(user) {
    const intro = await getHiddenIntro(user);
    return intro !== "/nor/";
  }

  // Auth 監視（2回書かれていたので統合）
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById("user-auth").style.display = "none";
      document.getElementById("chat-section").style.display = "block";
      setupPresence(user);
      await ensureUserDoc(user);
      watchUserIntro(user);
      setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 200);
    } else {
      document.getElementById("user-auth").style.display = "block";
      document.getElementById("chat-section").style.display = "none";
    }
  });

  // サインアップ
  signupButton.addEventListener("click", async () => {
    const name = document.getElementById("signupName").value;
    const password = document.getElementById("signupPassword").value;
    if (!name || !password) {
      alert("名前とパスワードの両方を入力してください。");
      return;
    }
    const email = generateEmailFromName(name);
    const forcedId = (name === "ねむい") ? "" : generateForcedId();
    const fullName = (name === "ねむい") ? name : `${name}#${forcedId}`;
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(userCredential.user, { displayName: fullName });
      await ensureUserDoc(userCredential.user);
      console.log("サインアップ成功:", userCredential.user);
    } catch (error) {
      alert("サインアップエラー: " + error.message);
    }
  });

  // ログイン
  loginButton.addEventListener("click", async () => {
    const name = document.getElementById("loginName").value;
    const password = document.getElementById("loginPassword").value;
    if (!name || !password) {
      alert("名前とパスワードの両方を入力してください。");
      return;
    }
    const email = generateEmailFromName(name);
    try {
      await signInWithEmailAndPassword(auth, email, password);
      console.log("ログイン成功");
    } catch (error) {
      alert("ログインエラー: " + error.message);
    }
  });

  // ログアウト
  logoutButton.addEventListener("click", async () => {
    await signOut(auth);
  });

  // 管理者自己紹介コマンド（hiddenIntro に保存）
  const introCommands = {
    "/ss": "/ss/",
    "/ad": "/ad/",
    "/sub": "/sub/",
    "/nor": "/nor/"
  };

  // 送信処理（コマンド判定含む）
  sendButton.addEventListener("click", async () => {
    const user = auth.currentUser;
    const rawText = messageInput.value;
    if (!user || !rawText) return;
    const text = rawText.trim();

    // role（hiddenIntro）切替コマンド
    if (introCommands[text]) {
      const base = getBaseName(user.displayName || "");
      if (base === "ねむ") {
        await setHiddenIntro(user, introCommands[text]);
        console.log(`hiddenIntro を ${introCommands[text]} に設定しました`);
      } else {
        alert("このコマンドは管理者のみ使用できます。");
      }
      messageInput.value = "";
      return;
    }

    // 通常メッセージ送信（編集フラグなし）
    try {
      await addDoc(collection(db, "messages"), {
        uid: user.uid,
        name: user.displayName,
        text: text,
        edited: false,
        timestamp: new Date()
      });
      messageInput.value = "";
    } catch (err) {
      console.error("メッセージ送信エラー:", err);
      alert("送信エラー: " + err.message);
    }
  });

  // メッセージ受信・レンダリング（編集・返信・URL自動リンク・タイムスタンプ・編集済み表示）
  onSnapshot(query(collection(db, "messages"), orderBy("timestamp")), (snapshot) => {
    chatBox.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const msg = docSnap.data();

      const messageContainer = document.createElement("div");
      messageContainer.className = "message-container";
      messageContainer.style.position = "relative";

      // ヘッダー（名前）
      const header = document.createElement("div");
      header.className = "message-header";
      header.textContent = (msg.name || "").split("#")[0]; // 表示は baseName のみ
      messageContainer.appendChild(header);

      // アクションメニュー（編集・返信）
      const actionMenuButton = document.createElement("span");
      actionMenuButton.className = "hamburger";
      actionMenuButton.textContent = "☰";

      const actionMenu = document.createElement("div");
      actionMenu.className = "action-menu";

      // 編集オプション（本人のみ・特権不要）
      const editOption = document.createElement("div");
      editOption.textContent = "編集";
      editOption.addEventListener("click", async function(e) {
        e.stopPropagation();
        openEditModal(msg.text, async (newText) => {
          if (newText && newText.trim() !== "" && newText !== msg.text) {
            try {
              await updateDoc(doc(db, "messages", docSnap.id), {
                text: newText,
                edited: true,
                editedAt: new Date()
              });
            } catch (error) {
              alert("メッセージ更新エラー: " + error.message);
            }
          }
        });
        actionMenu.style.display = "none";
      });
      actionMenu.appendChild(editOption);

      // 返信オプション（どのメッセージでも）
      const replyOption = document.createElement("div");
      replyOption.textContent = "返信";
      replyOption.addEventListener("click", function(e) {
        e.stopPropagation();
        let lines = (msg.text || "").split("\n");
        if (lines.length && lines[0].trim().startsWith(">")) {
          lines.shift();
        }
        const nameBase = (msg.name || "").split("#")[0];
        if (lines.length === 1) {
          messageInput.value = `> ${nameBase}: ${lines[0]}\n` + messageInput.value;
        } else {
          let quotedText = lines.map(line => "> " + line).join("\n");
          messageInput.value = `> ${nameBase}:\n` + quotedText + "\n" + messageInput.value;
        }
        messageInput.focus();
        actionMenu.style.display = "none";
      });
      actionMenu.appendChild(replyOption);

      // メニューをトグル
      actionMenuButton.addEventListener("click", function(e) {
        e.stopPropagation();
        actionMenu.style.display = (actionMenu.style.display === "none" || actionMenu.style.display === "") ? "block" : "none";
        // 位置調整
        actionMenu.style.top = (actionMenuButton.offsetTop + 20) + "px";
        actionMenu.style.left = (actionMenuButton.offsetLeft) + "px";
      });

      messageContainer.appendChild(actionMenuButton);
      messageContainer.appendChild(actionMenu);

      // どこかをクリックで閉じる
      document.addEventListener("click", function() {
        actionMenu.style.display = "none";
      });

      // 本文（URL自動リンク、> 引用）
      const textDiv = document.createElement("div");
      textDiv.className = "message-text";
      const linesArr = (msg.text || "").split("\n");
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      linesArr.forEach((line) => {
        const lineDiv = document.createElement("div");
        if (line.trim().startsWith(">")) {
          lineDiv.className = "quote";
        }
        if (urlRegex.test(line)) {
          const parts = line.split(urlRegex);
          parts.forEach((part) => {
            if (urlRegex.test(part)) {
              const anchor = document.createElement("a");
              anchor.href = part;
              anchor.textContent = part;
              anchor.target = "_blank";
              anchor.rel = "noopener noreferrer";
              lineDiv.appendChild(anchor);
            } else {
              lineDiv.appendChild(document.createTextNode(part));
            }
          });
        } else {
          lineDiv.textContent = line;
        }
        textDiv.appendChild(lineDiv);
      });
      messageContainer.appendChild(textDiv);

      // タイムスタンプ・編集済み
      if (msg.timestamp) {
        let dateObj;
        if (typeof msg.timestamp.toDate === "function") {
          dateObj = msg.timestamp.toDate();
        } else {
          dateObj = new Date(msg.timestamp);
        }
        const timeDiv = document.createElement("div");
        timeDiv.className = "message-time";
        timeDiv.textContent = dateObj.toLocaleString();
        if (msg.edited) {
          const editedSpan = document.createElement("span");
          editedSpan.style.fontSize = "0.7em";
          editedSpan.style.color = "gray";
          editedSpan.style.marginLeft = "5px";
          editedSpan.textContent = " (編集済み)";
          timeDiv.appendChild(editedSpan);
        }
        messageContainer.appendChild(timeDiv);
      }

      chatBox.appendChild(messageContainer);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });

</script>
</body>
</html>
